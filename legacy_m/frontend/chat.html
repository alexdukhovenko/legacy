<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>НАСЛЕДИЕ — Чат</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/frontend/styles_unified.css">
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <a class="brand" href="/frontend/index.html">
        <span class="brand-logo" aria-hidden="true"></span>
        <span class="brand-name">НАСЛЕДИЕ</span>
      </a>
      <div class="nav-actions">
        <a class="btn btn-ghost" href="/frontend/auth.html">Войти</a>
        <a class="btn btn-primary" href="/frontend/auth.html">Регистрация</a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="card chat-wrap" id="chat">
      <div class="chat-header">
        <div class="badge orthodox"><i></i> Православие</div>
        <div class="mute">ИИ-наставник</div>
      </div>

      <div class="chat-stream" id="chat-stream" aria-live="polite" aria-busy="false">
        <!-- сообщения рендерите сюда -->
        <!-- пример: -->
        <div class="msg assistant">
          <div class="meta">Наставник • сейчас</div>
          Здравствуйте! Чем могу помочь?
        </div>
      </div>

      <div class="chat-composer">
        <div class="input">
          <span class="chip">/orthodox</span>
          <textarea id="message" placeholder="Задайте вопрос…" rows="1"></textarea>
        </div>
        <button class="btn btn-primary" id="send">Отправить</button>
      </div>
    </div>

    <div class="center spacer">
      <div id="typing" class="typing hidden"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    </div>
  </main>

  <script>
    const textarea = document.getElementById('message');
    const stream = document.getElementById('chat-stream');
    const typing = document.getElementById('typing');
    const sendBtn = document.getElementById('send');

    // Авто-рост textarea
    textarea.addEventListener('input', () => {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 180) + 'px';
    });

    // Пример работы индикатора «печатает…»
    function showTyping(on=true){
      typing.classList.toggle('hidden', !on);
      stream.setAttribute('aria-busy', on ? 'true' : 'false');
    }

    // Автоскролл вниз
    function scrollToBottom(){
      stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' });
    }

    // Заглушка отправки (впаяйте ваш /api/chat)
    sendBtn.addEventListener('click', async () => {
      const text = textarea.value.trim();
      if(!text) return;
      // Рендерим юзер-сообщение
      stream.insertAdjacentHTML('beforeend', `
        <div class="msg user"><div class="meta">Вы • сейчас</div>${escapeHtml(text)}</div>
      `);
      textarea.value = ''; textarea.dispatchEvent(new Event('input'));
      scrollToBottom();
      showTyping(true);

      try {
        // TODO: замените на ваш вызов API
        const reply = await fakeCall(text);
        stream.insertAdjacentHTML('beforeend', `
          <div class="msg assistant">
            <div class="meta">Наставник • сейчас</div>${escapeHtml(reply.text)}
            ${renderSources(reply.sources)}
          </div>`);
      } catch(e){
        stream.insertAdjacentHTML('beforeend', `<div class="msg assistant"><div class="meta">Система</div>Произошла ошибка. Попробуйте ещё раз.</div>`);
      } finally {
        showTyping(false); scrollToBottom();
      }
    });

    function renderSources(sources=[]){
      if(!sources.length) return '';
      const lis = sources.map(s => `<li>${escapeHtml(s.title)} — <span class="mute">${escapeHtml(s.ref)}</span></li>`).join('');
      return `<div class="sources"><strong>Источники:</strong><ul>${lis}</ul></div>`;
    }
    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]))}
    async function fakeCall(q){ return new Promise(r=>setTimeout(()=>r({ text:"Принято. Формирую ответ…", sources:[] }), 600)) }
  </script>
</body>
</html>
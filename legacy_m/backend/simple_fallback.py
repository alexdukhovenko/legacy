#!/usr/bin/env python3
"""
–ü—Ä–æ—Å—Ç–æ–π fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
"""

import logging
from typing import List, Dict, Any

logger = logging.getLogger(__name__)

class SimpleFallback:
    """–ü—Ä–æ—Å—Ç–æ–π fallback –±–µ–∑ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤"""
    
    def __init__(self):
        self.orthodox_responses = {
            "–º–æ–ª–∏—Ç–≤–∞": {
                "response": "–í –ï–≤–∞–Ω–≥–µ–ª–∏–∏ –æ—Ç –ú–∞—Ç—Ñ–µ—è (6:9) –ò–∏—Å—É—Å —É—á–∏—Ç –º–æ–ª–∏—Ç–≤–µ '–û—Ç—á–µ –Ω–∞—à'. –°–≤—è—Ç—ã–µ –æ—Ç—Ü—ã –≥–æ–≤–æ—Ä—è—Ç, —á—Ç–æ –º–æ–ª–∏—Ç–≤–∞ –µ—Å—Ç—å –≤–æ–∑–Ω–æ—à–µ–Ω–∏–µ —É–º–∞ –∏ —Å–µ—Ä–¥—Ü–∞ –∫ –ë–æ–≥—É.\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ú–æ–ª–∏—Ç–µ—Å—å –∏—Å–∫—Ä–µ–Ω–Ω–µ, —Å –≤–µ—Ä–æ–π –∏ —Å–º–∏—Ä–µ–Ω–∏–µ–º, –∫–∞–∫ —É—á–∏–ª –•—Ä–∏—Å—Ç–æ—Å.",
                "sources": [
                    {
                        "type": "orthodox",
                        "source": "–ï–≤–∞–Ω–≥–µ–ª–∏–µ –æ—Ç –ú–∞—Ç—Ñ–µ—è 6:9",
                        "content": {
                            "book_name": "–ï–≤–∞–Ω–≥–µ–ª–∏–µ –æ—Ç –ú–∞—Ç—Ñ–µ—è",
                            "chapter_number": 6,
                            "verse_number": 9,
                            "translation_ru": "–û—Ç—á–µ –Ω–∞—à, —Å—É—â–∏–π –Ω–∞ –Ω–µ–±–µ—Å–∞—Ö! –¥–∞ —Å–≤—è—Ç–∏—Ç—Å—è –∏–º—è –¢–≤–æ–µ;"
                        }
                    }
                ],
                "confidence": 0.8
            },
            "–≤–µ—Ä–∞": {
                "response": "–í –ü–æ—Å–ª–∞–Ω–∏–∏ –∫ –ï–≤—Ä–µ—è–º (11:1) –≥–æ–≤–æ—Ä–∏—Ç—Å—è: '–í–µ—Ä–∞ –∂–µ –µ—Å—Ç—å –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –Ω–µ–≤–∏–¥–∏–º–æ–º'.\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –í–µ—Ä–∞ - —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ —Ö—Ä–∏—Å—Ç–∏–∞–Ω—Å–∫–æ–π –∂–∏–∑–Ω–∏, –¥–æ–≤–µ—Ä–∏–µ –ë–æ–≥—É –≤–æ –≤—Å–µ—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö.",
                "sources": [
                    {
                        "type": "orthodox",
                        "source": "–ü–æ—Å–ª–∞–Ω–∏–µ –∫ –ï–≤—Ä–µ—è–º 11:1",
                        "content": {
                            "book_name": "–ü–æ—Å–ª–∞–Ω–∏–µ –∫ –ï–≤—Ä–µ—è–º",
                            "chapter_number": 11,
                            "verse_number": 1,
                            "translation_ru": "–í–µ—Ä–∞ –∂–µ –µ—Å—Ç—å –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –Ω–µ–≤–∏–¥–∏–º–æ–º"
                        }
                    }
                ],
                "confidence": 0.8
            },
            "–ª—é–±–æ–≤—å": {
                "response": "–í –ï–≤–∞–Ω–≥–µ–ª–∏–∏ –æ—Ç –ò–æ–∞–Ω–Ω–∞ (13:34) –ò–∏—Å—É—Å –≥–æ–≤–æ—Ä–∏—Ç: '–ó–∞–ø–æ–≤–µ–¥—å –Ω–æ–≤—É—é –¥–∞—é –≤–∞–º, –¥–∞ –ª—é–±–∏—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞'.\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –õ—é–±–æ–≤—å - —ç—Ç–æ –≤—ã—Å—à–∞—è —Ö—Ä–∏—Å—Ç–∏–∞–Ω—Å–∫–∞—è –¥–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–∞—Å —Å –ë–æ–≥–æ–º –∏ –±–ª–∏–∂–Ω–∏–º–∏.",
                "sources": [
                    {
                        "type": "orthodox",
                        "source": "–ï–≤–∞–Ω–≥–µ–ª–∏–µ –æ—Ç –ò–æ–∞–Ω–Ω–∞ 13:34",
                        "content": {
                            "book_name": "–ï–≤–∞–Ω–≥–µ–ª–∏–µ –æ—Ç –ò–æ–∞–Ω–Ω–∞",
                            "chapter_number": 13,
                            "verse_number": 34,
                            "translation_ru": "–ó–∞–ø–æ–≤–µ–¥—å –Ω–æ–≤—É—é –¥–∞—é –≤–∞–º, –¥–∞ –ª—é–±–∏—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞"
                        }
                    }
                ],
                "confidence": 0.8
            }
        }
        
        self.sunni_responses = {
            "–º–æ–ª–∏—Ç–≤–∞": {
                "response": "–í –ö–æ—Ä–∞–Ω–µ, —Å—É—Ä–∞ 2, –∞—è—Ç 3 –≥–æ–≤–æ—Ä–∏—Ç—Å—è –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –º–æ–ª–∏—Ç–≤—ã: '–ö–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä—É—é—Ç –≤ —Å–æ–∫—Ä–æ–≤–µ–Ω–Ω–æ–µ –∏ –≤—ã—Å—Ç–∞–∏–≤–∞—é—Ç –º–æ–ª–∏—Ç–≤—É'.\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ú–æ–ª–∏—Ç–≤–∞ (—Å–∞–ª—è—Ç) - —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ –ø—è—Ç–∏ —Å—Ç–æ–ª–ø–æ–≤ –∏—Å–ª–∞–º–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –º—É—Å—É–ª—å–º–∞–Ω.",
                "sources": [
                    {
                        "type": "quran",
                        "source": "–ö–æ—Ä–∞–Ω 2:3",
                        "content": {
                            "surah_number": 2,
                            "verse_number": 3,
                            "translation_ru": "–ö–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä—É—é—Ç –≤ —Å–æ–∫—Ä–æ–≤–µ–Ω–Ω–æ–µ –∏ –≤—ã—Å—Ç–∞–∏–≤–∞—é—Ç –º–æ–ª–∏—Ç–≤—É"
                        }
                    }
                ],
                "confidence": 0.8
            }
        }
        
        self.shia_responses = {
            "–º–æ–ª–∏—Ç–≤–∞": {
                "response": "–í –ö–æ—Ä–∞–Ω–µ, —Å—É—Ä–∞ 2, –∞—è—Ç 3 –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ—Ç—Å—è –≤–∞–∂–Ω–æ—Å—Ç—å –º–æ–ª–∏—Ç–≤—ã –¥–ª—è –≤–µ—Ä—É—é—â–∏—Ö. –ò–º–∞–º –ê–ª–∏ –≥–æ–≤–æ—Ä–∏–ª –æ –∑–Ω–∞—á–µ–Ω–∏–∏ –∏—Å–∫—Ä–µ–Ω–Ω–µ–π –º–æ–ª–∏—Ç–≤—ã.\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ú–æ–ª–∏—Ç–≤–∞ - —ç—Ç–æ —Å–≤—è–∑—å —Å –ê–ª–ª–∞—Ö–æ–º, –∫–æ—Ç–æ—Ä–∞—è –æ—á–∏—â–∞–µ—Ç –¥—É—à—É –∏ —É–∫—Ä–µ–ø–ª—è–µ—Ç –≤–µ—Ä—É.",
                "sources": [
                    {
                        "type": "quran",
                        "source": "–ö–æ—Ä–∞–Ω 2:3",
                        "content": {
                            "surah_number": 2,
                            "verse_number": 3,
                            "translation_ru": "–ö–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä—É—é—Ç –≤ —Å–æ–∫—Ä–æ–≤–µ–Ω–Ω–æ–µ –∏ –≤—ã—Å—Ç–∞–∏–≤–∞—é—Ç –º–æ–ª–∏—Ç–≤—É"
                        }
                    }
                ],
                "confidence": 0.8
            }
        }
    
    def generate_response(self, question: str, confession: str, relevant_texts: List[Dict[str, Any]] = None) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤"""
        
        question_lower = question.lower()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –≤–æ–ø—Ä–æ—Å–∞
        theme = self._extract_theme(question_lower)
        
        # –í—ã–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–µ—Å—Å–∏–∏
        if confession == "orthodox":
            responses = self.orthodox_responses
        elif confession == "sunni":
            responses = self.sunni_responses
        elif confession == "shia":
            responses = self.shia_responses
        else:
            responses = self.orthodox_responses  # fallback
        
        # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç
        if theme in responses:
            logger.info(f"üéØ Fallback: –Ω–∞–π–¥–µ–Ω –æ—Ç–≤–µ—Ç –¥–ª—è —Ç–µ–º—ã '{theme}' –∏ –∫–æ–Ω—Ñ–µ—Å—Å–∏–∏ '{confession}'")
            return responses[theme]
        
        # –û–±—â–∏–π –æ—Ç–≤–µ—Ç
        if confession == "orthodox":
            return {
                "response": "–í –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–≤—è—â–µ–Ω–Ω–∏–∫—É –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è.\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è —Å–≤—è—â–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –¥—É—Ö–æ–≤–Ω—ã–º –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–º.",
                "sources": [],
                "confidence": 0.3
            }
        else:
            return {
                "response": "–í –∏—Å–ª–∞–º—Å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∏–º–∞–º—É –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è.\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∏–∑—É—á–µ–Ω–∏—è –ö–æ—Ä–∞–Ω–∞ –∏ –°—É–Ω–Ω—ã, –∞ —Ç–∞–∫–∂–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –∑–Ω–∞—é—â–∏–º –º—É—Å—É–ª—å–º–∞–Ω–∏–Ω–æ–º.",
                "sources": [],
                "confidence": 0.3
            }
    
    def _extract_theme(self, question: str) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–º—É –∏–∑ –≤–æ–ø—Ä–æ—Å–∞"""
        
        themes = {
            "–º–æ–ª–∏—Ç–≤–∞": ["–º–æ–ª–∏—Ç–≤–∞", "–º–æ–ª–∏—Ç—å—Å—è", "–º–æ–ª–∏—Ç—Å—è", "–º–æ–ª–∏–ª—Å—è", "–º–æ–ª–∏–ª–∞—Å—å", "–º–æ–ª–∏–º—Å—è", "–º–æ–ª–∏—Ç–µ—Å—å", "–º–æ–ª—è—Ç—Å—è"],
            "–≤–µ—Ä–∞": ["–≤–µ—Ä–∞", "–≤–µ—Ä–æ–≤–∞—Ç—å", "–≤–µ—Ä—é", "–≤–µ—Ä—É–µ—Ç", "–≤–µ—Ä—É—é—â–∏–π", "–≤–µ—Ä—É—é—â–∞—è"],
            "–ª—é–±–æ–≤—å": ["–ª—é–±–æ–≤—å", "–ª—é–±–∏—Ç—å", "–ª—é–±–ª—é", "–ª—é–±–∏—Ç", "–ª—é–±—è—â–∏–π", "–ª—é–±—è—â–∞—è"],
            "–≥—Ä–µ—Ö": ["–≥—Ä–µ—Ö", "–≥—Ä–µ—à–∏—Ç—å", "–≥—Ä–µ—à—É", "–≥—Ä–µ—à–∏—Ç", "–≥—Ä–µ—à–Ω—ã–π", "–≥—Ä–µ—à–Ω–∞—è"],
            "–ø–æ–∫–∞—è–Ω–∏–µ": ["–ø–æ–∫–∞—è–Ω–∏–µ", "–∫–∞—è—Ç—å—Å—è", "–∫–∞—é—Å—å", "–∫–∞–µ—Ç—Å—è", "–∫–∞—é—â–∏–π—Å—è", "–∫–∞—é—â–∞—è—Å—è"],
            "–±–æ–≥": ["–±–æ–≥", "–∞–ª–ª–∞—Ö", "–≥–æ—Å–ø–æ–¥—å", "—Ç–≤–æ—Ä–µ—Ü", "—Å–æ–∑–¥–∞—Ç–µ–ª—å"],
            "–ø—Ä–æ—Ä–æ–∫": ["–ø—Ä–æ—Ä–æ–∫", "–º—É—Ö–∞–º–º–∞–¥", "–∏–∏—Å—É—Å", "—Ö—Ä–∏—Å—Ç–æ—Å", "–º–µ—Å—Å–∏—è"],
            "—Å–º–µ—Ä—Ç—å": ["—Å–º–µ—Ä—Ç—å", "—É–º–µ—Ä–µ—Ç—å", "—É–º–∏—Ä–∞—Ç—å", "—É–º–µ—Ä", "—É–º–µ—Ä–ª–∞", "—É–º–∏—Ä–∞–µ—Ç"],
            "–∂–∏–∑–Ω—å": ["–∂–∏–∑–Ω—å", "–∂–∏—Ç—å", "–∂–∏–≤—É", "–∂–∏–≤–µ—Ç", "–∂–∏–≤—É—â–∏–π", "–∂–∏–≤—É—â–∞—è"]
        }
        
        for theme, keywords in themes.items():
            if any(keyword in question for keyword in keywords):
                return theme
        
        return "–æ–±—â–µ–µ"

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
simple_fallback = SimpleFallback()

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ банковских выписок - Браузерная версия</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background-color: #e9ecef;
            border-color: #0056b3;
        }
        .upload-area.dragover {
            background-color: #d1ecf1;
            border-color: #17a2b8;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card.income {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .stat-card.expense {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
        }
        .stat-card.balance {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .transaction-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .category-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                Анализ банковских выписок
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Загрузка файлов -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload me-2"></i>Загрузка банковских выписок</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Перетащите CSV файлы сюда или нажмите для выбора</h5>
                            <p class="text-muted">Поддерживаемые форматы: CSV файлы любых банков (Сбербанк, Тинькофф, ВТБ, Альфа-Банк и др.)</p>
                            <input type="file" id="fileInput" multiple accept=".csv" style="display: none;">
                        </div>
                        <div class="loading text-center mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="mt-2">Обработка файлов...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Сводка -->
        <div class="row mb-4" id="summarySection" style="display: none;">
            <div class="col-md-4">
                <div class="stat-card income">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Доходы</h6>
                            <h3 id="totalIncome">0 ₽</h3>
                        </div>
                        <i class="fas fa-arrow-up fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card expense">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Расходы</h6>
                            <h3 id="totalExpense">0 ₽</h3>
                        </div>
                        <i class="fas fa-arrow-down fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card balance">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Баланс</h6>
                            <h3 id="totalBalance">0 ₽</h3>
                        </div>
                        <i class="fas fa-balance-scale fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Графики -->
        <div class="row mb-4" id="chartsSection" style="display: none;">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-pie me-2"></i>Расходы по категориям</h5>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line me-2"></i>Месячный баланс</h5>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Транзакции -->
        <div class="row mb-4" id="transactionsSection" style="display: none;">
            <div class="col-12">
                <div class="transaction-table">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list me-2"></i>Транзакции</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="exportCSV()">
                                <i class="fas fa-file-csv me-1"></i>Экспорт CSV
                            </button>
                            <button class="btn btn-info btn-sm" onclick="exportJSON()">
                                <i class="fas fa-file-code me-1"></i>Экспорт JSON
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Дата</th>
                                    <th>Описание</th>
                                    <th>Сумма</th>
                                    <th>Категория</th>
                                    <th>Банк</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Глобальные переменные
        let transactions = [];
        let currentPage = 1;
        let itemsPerPage = 50;
        let categoryChart = null;
        let monthlyChart = null;

        // Правила категоризации
        const categoryRules = {
            "Продукты": ["магнит", "пятерочка", "перекресток", "ашан", "лента", "продукты", "еда", "кафе", "ресторан", "яндекс.еда", "доставка еды", "супермаркет"],
            "Транспорт": ["яндекс.такси", "uber", "метро", "автобус", "бензин", "заправка", "парковка", "транспорт", "яндекс.го", "каршеринг", "электросамокат"],
            "Коммунальные": ["жкх", "электричество", "газ", "вода", "отопление", "коммунальные", "квартплата", "управляющая компания"],
            "Связь": ["мтс", "билайн", "мегафон", "теле2", "интернет", "связь", "мобильная связь", "ростелеком"],
            "Здоровье": ["аптека", "больница", "поликлиника", "врач", "лекарства", "медицина", "стоматолог", "медцентр"],
            "Образование": ["школа", "университет", "курсы", "обучение", "образование", "детский сад", "репетитор"],
            "Развлечения": ["кино", "театр", "концерт", "игры", "развлечения", "отдых", "netflix", "spotify", "яндекс.музыка"],
            "Одежда": ["одежда", "обувь", "магазин одежды", "h&m", "zara", "uniqlo", "wildberries", "ozon"],
            "Доходы": ["зарплата", "доход", "перевод", "возврат", "проценты", "дивиденды", "пенсия", "пособие"],
            "Инвестиции": ["акции", "облигации", "депозит", "инвестиции", "брокер", "тинькофф инвестиции", "сбербанк инвестиции"],
            "Прочее": []
        };

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializeUpload();
        });

        // Инициализация загрузки файлов
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Клик по области загрузки
            uploadArea.addEventListener('click', () => fileInput.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            // Выбор файлов
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // Обработка загруженных файлов
        async function handleFiles(files) {
            if (files.length === 0) return;

            showLoading(true);
            transactions = [];

            try {
                for (let file of files) {
                    if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        const fileTransactions = await parseCSV(file);
                        transactions = transactions.concat(fileTransactions);
                    }
                }

                if (transactions.length > 0) {
                    showSuccess(`Обработано ${transactions.length} транзакций`);
                    updateAnalytics();
                    showSections();
                } else {
                    showError('Не удалось обработать транзакции');
                }
            } catch (error) {
                showError('Ошибка обработки файлов: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Парсинг CSV файла
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        let csv = e.target.result;
                        console.log('Начало парсинга файла:', file.name);
                        
                        const lines = csv.split('\n').filter(line => line.trim());
                        if (lines.length < 2) {
                            reject(new Error('Файл слишком короткий или пустой'));
                            return;
                        }
                        
                        // Определяем разделитель
                        const firstLine = lines[0];
                        const delimiter = firstLine.includes('\t') ? '\t' : ',';
                        console.log('Разделитель:', delimiter);
                        
                        // Ищем заголовки (может быть не в первой строке)
                        let headerLine = 0;
                        let headers = [];
                        
                        for (let i = 0; i < Math.min(5, lines.length); i++) {
                            const testHeaders = parseCSVLine(lines[i], delimiter).map(h => h.trim().toLowerCase());
                            console.log(`Строка ${i}:`, testHeaders);
                            
                            // Проверяем, есть ли в этой строке нужные колонки
                            if (testHeaders.some(h => h.includes('дата') || h.includes('date') || h.includes('sum') || h.includes('сумма'))) {
                                headers = testHeaders;
                                headerLine = i;
                                break;
                            }
                        }
                        
                        if (headers.length === 0) {
                            // Если не нашли заголовки, используем первую строку
                            headers = parseCSVLine(firstLine, delimiter).map(h => h.trim().toLowerCase());
                        }
                        
                        console.log('Используемые заголовки:', headers);
                        console.log('Строка заголовков:', headerLine);
                        
                        const transactions = [];
                        
                        // Ищем нужные колонки
                        const dateIndex = findColumnIndex(headers, [
                            'дата', 'date', 'время', 'time', 'date_oper', 'дата_опер'
                        ]);
                        const amountIndex = findColumnIndex(headers, [
                            'сумма', 'amount', 'сум', 'руб', 'rub', 'sum_rur', 'сум_руб'
                        ]);
                        const descIndex = findColumnIndex(headers, [
                            'описание', 'description', 'назначение', 'комментарий', 'text70'
                        ]);
                        const typeIndex = findColumnIndex(headers, [
                            'тип', 'type', 'd_c', 'операция', 'operation'
                        ]);
                        
                        console.log('Найденные индексы:', {dateIndex, amountIndex, descIndex, typeIndex});
                        
                        // Если не нашли нужные колонки, пробуем взять первые 3
                        if (dateIndex === -1 || amountIndex === -1 || descIndex === -1) {
                            if (headers.length >= 3) {
                                console.log('Используем первые 3 колонки');
                                for (let i = headerLine + 1; i < lines.length; i++) {
                                    const line = lines[i].trim();
                                    if (!line || line.startsWith('ID-записи')) continue;
                                    
                                    const values = parseCSVLine(line, delimiter);
                                    if (values.length < 3) continue;
                                    
                                    try {
                                        const date = values[0];
                                        let amountStr = values[1].replace(',', '.').replace(/[^\d.-]/g, '');
                                        const description = values[2];
                                        
                                        let amount = parseFloat(amountStr);
                                        if (isNaN(amount) || amount === 0) continue;
                                        
                                        // Определяем знак суммы
                                        amount = determineAmountSign(amount, description, values[3] || '');
                                        
                                        const formattedDate = formatDate(date);
                                        if (!formattedDate) continue;
                                        
                                        const transaction = {
                                            date: formattedDate,
                                            description: description,
                                            amount: amount,
                                            category: categorizeTransaction(description),
                                            bank: file.name.replace('.csv', ''),
                                            transaction_type: amount > 0 ? 'income' : 'expense'
                                        };
                                        transactions.push(transaction);
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                reject(new Error('Не найдены нужные колонки в файле'));
                                return;
                            }
                        } else {
                            // Стандартная обработка
                            for (let i = headerLine + 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line || line.startsWith('ID-записи')) continue;
                                
                                const values = parseCSVLine(line, delimiter);
                                if (values.length <= Math.max(dateIndex, amountIndex, descIndex)) continue;
                                
                                try {
                                    const date = values[dateIndex];
                                    let amountStr = values[amountIndex].replace(',', '.').replace(/[^\d.-]/g, '');
                                    const description = values[descIndex];
                                    const typeValue = typeIndex !== -1 ? values[typeIndex] : '';
                                    
                                    let amount = parseFloat(amountStr);
                                    if (isNaN(amount) || amount === 0) continue;
                                    
                                    // Определяем знак суммы
                                    amount = determineAmountSign(amount, description, typeValue);
                                    
                                    const formattedDate = formatDate(date);
                                    if (!formattedDate) continue;
                                    
                                    const transaction = {
                                        date: formattedDate,
                                        description: description,
                                        amount: amount,
                                        category: categorizeTransaction(description),
                                        bank: file.name.replace('.csv', ''),
                                        transaction_type: amount > 0 ? 'income' : 'expense'
                                    };
                                    transactions.push(transaction);
                                } catch (e) {
                                    continue;
                                }
                            }
                        }
                        
                        console.log(`Обработано ${transactions.length} транзакций`);
                        resolve(transactions);
                    } catch (error) {
                        console.error('Ошибка парсинга:', error);
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Ошибка чтения файла'));
                reader.readAsText(file, 'utf-8');
            });
        }
        
        // Определение знака суммы
        function determineAmountSign(amount, description, typeValue) {
            const descLower = description.toLowerCase();
            const typeLower = typeValue.toLowerCase();
            
            // Проверяем тип операции (для Сбербанка и других банков)
            if (typeLower === 'd' || typeLower === 'debit' || typeLower.includes('расход') || typeLower.includes('списание')) {
                return -Math.abs(amount);
            } else if (typeLower === 'c' || typeLower.includes('credit') || typeLower.includes('приход') || typeLower.includes('зачисление')) {
                return Math.abs(amount);
            }
            
            // Автоматическое определение по ключевым словам в описании
            const expenseKeywords = ['списание', 'расход', 'оплата', 'покупка', 'перевод', 'комиссия', 'платеж'];
            const incomeKeywords = ['зачисление', 'приход', 'возврат', 'зарплата', 'доход'];
            
            if (expenseKeywords.some(keyword => descLower.includes(keyword))) {
                return -Math.abs(amount);
            } else if (incomeKeywords.some(keyword => descLower.includes(keyword))) {
                return Math.abs(amount);
            }
            
            // По умолчанию считаем положительным (доход)
            return Math.abs(amount);
        }
        
        // Форматирование даты
        function formatDate(dateStr) {
            if (!dateStr) return null;
            
            try {
                // Убираем лишние символы
                dateStr = dateStr.replace(/[^\d.-]/g, '');
                
                // Пробуем разные форматы
                if (dateStr.includes('.')) {
                    const parts = dateStr.split('.');
                    if (parts.length === 3) {
                        let day = parts[0].padStart(2, '0');
                        let month = parts[1].padStart(2, '0');
                        let year = parts[2];
                        
                        if (year.length === 2) {
                            year = '20' + year;
                        }
                        
                        return `${year}-${month}-${day}`;
                    }
                } else if (dateStr.includes('-')) {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        return dateStr; // Уже в правильном формате
                    }
                }
                
                return null;
            } catch (e) {
                return null;
            }
        }

        // Парсинг строки CSV с учетом кавычек и табуляции
        function parseCSVLine(line, delimiter = ',') {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === delimiter && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Поиск индекса колонки
        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                if (keywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            return -1;
        }

        // Категоризация транзакции
        function categorizeTransaction(description) {
            const descLower = description.toLowerCase();
            
            for (const [category, keywords] of Object.entries(categoryRules)) {
                if (keywords.some(keyword => descLower.includes(keyword))) {
                    return category;
                }
            }
            
            return "Прочее";
        }

        // Обновление аналитики
        function updateAnalytics() {
            updateSummary();
            updateCategoryChart();
            updateMonthlyChart();
            displayTransactions();
        }

        // Обновление сводки
        function updateSummary() {
            const totalIncome = transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = Math.abs(transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0));
            const balance = totalIncome - totalExpense;

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('totalBalance').textContent = formatCurrency(balance);
        }

        // Обновление графика категорий
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            const expenseByCategory = {};
            transactions.filter(t => t.amount < 0).forEach(t => {
                expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
            });

            const labels = Object.keys(expenseByCategory);
            const values = Object.values(expenseByCategory).map(v => Math.abs(v));

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Обновление месячного графика
        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            const monthlyBalance = {};
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                monthlyBalance[monthKey] = (monthlyBalance[monthKey] || 0) + t.amount;
            });

            const labels = Object.keys(monthlyBalance).sort();
            const values = labels.map(label => monthlyBalance[label]);

            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Баланс',
                        data: values,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Отображение транзакций
        function displayTransactions(page = 1) {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = transactions.slice(startIndex, endIndex);

            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = '';

            pageTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.description}</td>
                    <td class="${transaction.amount > 0 ? 'text-success' : 'text-danger'}">
                        ${formatCurrency(transaction.amount)}
                    </td>
                    <td>
                        <span class="badge bg-secondary category-badge">${transaction.category}</span>
                    </td>
                    <td>${transaction.bank}</td>
                `;
                tbody.appendChild(row);
            });

            updatePagination(page);
        }

        // Обновление пагинации
        function updatePagination(currentPage) {
            const totalPages = Math.ceil(transactions.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Предыдущая страница
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="displayTransactions(${currentPage - 1})">Предыдущая</a>`;
            pagination.appendChild(prevLi);

            // Номера страниц
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="displayTransactions(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // Следующая страница
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="displayTransactions(${currentPage + 1})">Следующая</a>`;
            pagination.appendChild(nextLi);
        }

        // Экспорт в CSV
        function exportCSV() {
            if (transactions.length === 0) {
                showError('Нет данных для экспорта');
                return;
            }

            const headers = ['Дата', 'Описание', 'Сумма', 'Категория', 'Банк', 'Тип операции'];
            const csvContent = [
                headers.join(','),
                ...transactions.map(t => [
                    t.date,
                    `"${t.description}"`,
                    t.amount,
                    t.category,
                    t.bank,
                    t.transaction_type
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, 'financial_report.csv', 'text/csv');
        }

        // Экспорт в JSON
        function exportJSON() {
            if (transactions.length === 0) {
                showError('Нет данных для экспорта');
                return;
            }

            const jsonContent = JSON.stringify(transactions, null, 2);
            downloadFile(jsonContent, 'financial_report.json', 'application/json');
        }

        // Скачивание файла
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Показать секции
        function showSections() {
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('transactionsSection').style.display = 'block';
        }

        // Показать загрузку
        function showLoading(show) {
            const loading = document.querySelector('.loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // Показать успех
        function showSuccess(message) {
            showAlert(message, 'success');
        }

        // Показать ошибку
        function showError(message) {
            showAlert(message, 'danger');
        }

        // Показать уведомление
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Автоматически скрыть через 5 секунд
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Форматирование валюты
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Форматирование даты
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
    </script>
</body>
</html>
